# TopIt GreenWave 연동 시뮬레이터
## Claude Code 개발 설계서

---

## 1. 프로젝트 개요

교통신호 연동(Green Wave) 시뮬레이터.
주도로에 배치된 여러 교차로의 신호 옵셋을 조절하여,
차량이 연속 녹색 신호를 받으며 정차 없이 통과하는 "녹색 파도(Green Wave)"를 
시각적으로 시뮬레이션하고 최적 옵셋을 찾는 프로그램.

### 기존 프로그램 (탑아이티 v1.0)
- 테이블에 숫자 입력 → 정적 그래프 출력 (녹색/빨간색 밴드)
- 기능: 도로명, 주기, 옵셋, 현시, 거리 입력 → 시공도 분석 버튼
- 한계: 정적, 차량 움직임 없음, 실시간 조절 불가

### 우리가 만들 것 (상위호환)
- **60fps 실시간 차량 애니메이션** (Canvas)
- **시공간 다이어그램 실시간 연동**
- **옵셋 슬라이더로 즉시 반영**
- **양방향 차량 시뮬레이션**
- 한 화면에 도로뷰 + 시공간 다이어그램 동시 표시

---

## 2. 참조 파일

프로젝트 루트에 있는 `traffic-simulation.jsx` 파일이 **UI/UX 레퍼런스**입니다.

> ⚠️ 이 파일의 UI 스타일, 색상, 레이아웃, 인터랙션을 그대로 따라주세요.
> 기능을 확장하되 디자인 톤은 유지해야 합니다.

### 레퍼런스 UI 핵심 특징

**레이아웃:**
- 상단: 도로뷰 (Canvas) - 차량이 실제로 달림
- 하단: 시공간 다이어그램 (Canvas) - 실시간 연동
- 한 화면에 동시 표시 (탭 분리 X)
- 좌측 또는 상단에 입력 테이블 + 옵셋 슬라이더

**다크 모드 컬러:**
```
배경:       #0a0a1a (거의 검정 네이비)
카드:       #161625 (짙은 보라빛)
테두리:     #2a2a4a (은은한 보라)
서피스:     #111125
텍스트:     #e2e8f0 (밝은 회색)
텍스트뮤트: #64748b
텍스트딤:   #475569
녹색:       #22c55e (신호 녹색)
빨간:       #ef4444 (신호 적색)
황색:       #eab308 (신호 황색)
파란:       #3b82f6 (정방향 차량)
노란:       #f59e0b (역방향 차량)
그리드:     rgba(100,116,139,0.12)
```

**애니메이션:**
- 60fps requestAnimationFrame 루프
- Canvas 2D 렌더링
- 차량: 둥근 사각형 + 그림자/글로우 + 브레이크등
- 신호등: 발광 효과 (shadowBlur)
- 도로: 중앙선 점선, 차선 화살표

---

## 3. 화면 구성 상세

```
┌──────────────────────────────────────────────────────────────┐
│  🟢 TopIt GreenWave v2.0          [속도:40km/h] [배속:x1] [▶/⏸]  │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─ 도로 뷰 (Canvas) ──────────────────────────────────┐    │
│  │                                                       │    │
│  │   수청4R        대천중         한내초          흑포   │    │
│  │    🟢━━━━━━━━━━🔴━━━━━━━━━━━🟢━━━━━━━━━━━━🟢       │    │
│  │       🚙→  →🚗     🚗■        →🚙→  →🚗    →🚙      │    │
│  │    ←🚕   ←🚕      ←🚕■         ←🚕       ←🚕←🚕    │    │
│  │    0m          214m           417m          692m      │    │
│  └───────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─ 입력 테이블 ─────────────┐  ┌─ 옵셋 슬라이더 ────────┐  │
│  │ 도로명│주기│옵셋│녹색│거리│  │ 수청4R ━━━━━●━━━ 145   │  │
│  │ 수청4R│160│145│120│  0  │  │ 대천중 ━●━━━━━━━  40   │  │
│  │ 대천중│160│ 40│ 80│ 214 │  │ 한내초 ━━━━●━━━━ 130   │  │
│  │ 한내초│160│130│131│ 417 │  │ 흑포   ●━━━━━━━━   0   │  │
│  │ 흑포  │160│  0│ 70│ 692 │  └──────────────────────────┘  │
│  │ [+ 교차로 추가]          │                                │
│  └───────────────────────────┘                                │
│                                                              │
│  ┌─ 시공간 다이어그램 (Canvas) ─────────────────────────┐    │
│  │                                                       │    │
│  │  수청4R ▓▓▓▓▓▓▓▓▓▓░░░░░░▓▓▓▓▓▓▓▓▓▓░░░░░░           │    │
│  │         ╲                  ╲                          │    │
│  │  대천중 ░░░▓▓▓▓▓▓░░░░░░░░░▓▓▓▓▓▓░░░░               │    │
│  │           ╲                  ╲                        │    │
│  │  한내초 ░░░░░░▓▓▓▓▓▓▓▓░░░░░░░▓▓▓▓▓▓▓▓              │    │
│  │               ╲                  ╲                    │    │
│  │  흑포   ░░░░░░░░░▓▓▓▓░░░░░░░░░░░▓▓▓▓               │    │
│  │                                                       │    │
│  │  ▓=녹색(통행가능) ░=적색(통행불가) ╲=차량궤적        │    │
│  │  ──── 시간(s) ──→                                    │    │
│  └───────────────────────────────────────────────────────┘    │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 4. 기능 목록

### 4-1. 입력 테이블
| 필드 | 설명 | 비고 |
|------|------|------|
| 도로명 | 교차로 이름 | 텍스트 입력 |
| 주기 | 신호 주기(초) | 모든 교차로 동일 권장 |
| 옵셋 | 녹색 시작 지연(초) | 0~주기, 슬라이더로도 조절 |
| 녹색 | 녹색 시간(초) | = phases[0] |
| 현시2~8 | 추가 현시 | 접기/펼치기 |
| 거리(m) | 첫 교차로 기준 누적거리 | |

- 행 추가/삭제 가능
- 셀 직접 편집 가능
- 탑아이티 원본 데이터로 기본값 설정:
  ```
  수청4R: 주기160, 옵셋145, 녹색120, 거리0m
  대천중: 주기160, 옵셋40,  녹색80,  거리214m
  한내초: 주기160, 옵셋130, 녹색131, 거리417m
  흑포:   주기160, 옵셋0,   녹색70,  거리692m
  ```

### 4-2. 도로 뷰 (Canvas 60fps)
- 수평 도로 위에 교차로별 정지선 + 신호등 표시
- **정방향 차량** (파란색, →): 왼쪽에서 오른쪽으로 이동
- **역방향 차량** (노란색, ←): 오른쪽에서 왼쪽으로 이동
- 차량은 적색 신호 시 정지선 앞에서 감속 → 정지
- 녹색 전환 시 가속 → 출발
- 브레이크등 표시 (정지/감속 시 빨간 점)
- 신호등 발광 효과 (글로우)
- 중앙선 점선, 차선 방향 화살표

### 4-3. 시공간 다이어그램 (Canvas 60fps)
- X축: 시간(초), Y축: 거리(m)
- 각 교차로 위치에 녹색/적색 밴드 표시
- **차량 궤적선**: 대각선으로 차량 이동 경로 표시
  - 정방향: 파란 대각선 (좌하→우상)
  - 역방향: 노란 대각선 (좌상→우하)
  - 정지 시: 수직선 (시간만 지남)
- **현재 시간 표시선**: 세로 흰선이 이동
- **녹색 밴드**: 연동이 잘 되면 대각선과 녹색 밴드가 일치
- 실시간으로 차량 점이 이동

### 4-4. 옵셋 슬라이더
- 교차로별 수평 슬라이더 (0 ~ 주기)
- **드래그하면 즉시** 도로뷰 + 시공간 다이어그램에 반영
- 현재 값 숫자 표시
- 녹색 악센트 컬러

### 4-5. 컨트롤
- 주행속도: 20~80 km/h 슬라이더
- 시뮬 배속: x0.5, x1, x2, x4 버튼
- 시작/정지 토글 버튼
- 리셋 버튼

---

## 5. 신호 로직

```javascript
function getSignalState(time, intersection) {
  const { cycle, offset, phases } = intersection;
  const t = (((time - offset) % cycle) + cycle) % cycle;
  
  const greenTime = phases[0] || 0;    // 첫 번째 현시 = 주 녹색
  const yellowTime = 3;                 // 황색 고정 3초
  
  if (t < greenTime) return "green";
  if (t < greenTime + yellowTime) return "yellow";
  return "red";
}
```

### 차량 움직임 로직
```
매 프레임:
1. 전방 교차로 탐색 (30m 이내)
2. 적색/황색 → 감속 → 정지 (정지선 직전)
3. 녹색 → 가속 → 주행속도까지 복귀
4. 교차로 없으면 → 정상 주행
5. 화면 밖 차량 제거
6. 일정 간격으로 새 차량 생성 (양방향)
```

---

## 6. 기술 스택

```
- React (단일 컴포넌트)
- Canvas 2D (60fps requestAnimationFrame)
- 외부 라이브러리 없음
- 순수 JavaScript 물리 시뮬레이션
- 다크 모드 인라인 스타일
```

---

## 7. 파일 구조

```
TopIt-GreenWave/
├── src/
│   ├── App.jsx              # 메인 컴포넌트
│   ├── components/
│   │   ├── RoadCanvas.jsx   # 도로 뷰 Canvas
│   │   ├── TSDCanvas.jsx    # 시공간 다이어그램 Canvas  
│   │   ├── DataTable.jsx    # 입력 테이블
│   │   └── OffsetSliders.jsx # 옵셋 슬라이더
│   ├── engine/
│   │   ├── signal.js        # 신호 상태 계산
│   │   └── vehicle.js       # 차량 물리 시뮬레이션
│   └── styles/
│       └── colors.js        # 다크 모드 컬러 상수
├── traffic-simulation.jsx   # ★ UI 레퍼런스 (이 스타일 따라갈 것)
├── package.json
├── vite.config.js
└── README.md
```

---

## 8. 개발 지시

1. `traffic-simulation.jsx`를 먼저 읽고 UI/UX 스타일을 파악하세요.
2. 그 파일의 다크 모드 색상, Canvas 렌더링 방식, 레이아웃을 그대로 유지하세요.
3. 도로 뷰와 시공간 다이어그램이 **한 화면에 동시에** 보여야 합니다 (탭 분리 X).
4. 옵셋 슬라이더를 움직이면 **즉시** 양쪽 Canvas에 반영되어야 합니다.
5. 차량 애니메이션은 60fps로 부드럽게 동작해야 합니다.
6. 기본 데이터는 탑아이티 원본(수청4R, 대천중, 한내초, 흑포)을 사용하세요.
7. Vite + React로 프로젝트 구성하세요.

---

## 9. 확장 예정 (Phase 2)

- 자동 옵셋 최적화 (브루트포스 → 최적 녹색 밴드 탐색)
- TopIt-Traffic-db 연동 (요도에서 구간 선택 → 자동 데이터 로드)
- DAT 파일에서 타이밍 자동 임포트
- 연동 결과 리포트 PDF 출력
- 다구간 동시 시뮬레이션
