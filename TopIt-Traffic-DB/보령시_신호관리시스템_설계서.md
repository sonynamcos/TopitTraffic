# 보령시 교통신호제어기 통합관리 시스템
## Claude Code 개발 설계서

---

## 1. 프로젝트 배경 (왜 만드는가)

### 현재 상황 (카오스)
```
현재 폴더 구조 (실제):
📁 dat파일/
  ├── 해날아파트.dat          ← 이게 최신인지 옛날건지 모름
  ├── 해날아파트(1).dat       ← 중복
  ├── 해날아파트_백업.dat     ← 뭔지 모름
  ├── data_032.dat            ← 이름만 봐선 어느 교차로인지 모름
  ├── 한진_뭐시기.dat         ← 한진이엔씨 파일이 섞여있음
  ├── 서돌_해수욕장.dat       ← 서돌인지 한진인지 확신 없음
  └── ... (수십~수백 개)

📁 주기표/
  ├── 주기표_2023.xlsx        ← 시트 20개에 교차로별로 나눠놓음
  ├── 주기표_최신.xlsx        ← "최신"이라는데 진짜 최신인지?
  ├── 보령_주기표_수정.xlsx   ← 전임자가 하다 만 흔적
  └── ... 

📁 요도/
  └── 보령시_요도.xlsx        ← 엑셀로 그린 요도. 확대축소 안됨. 수정 지옥.
```

### 문제점
- DAT 파일: 한진/서돌 구분 불가, 중복, 이름 불일치, 버전 신뢰 0
- 주기표: 시트 기반이라 찾기 불편, 어떤 DAT와 매칭인지 불명
- 요도: 엑셀이라 확대/축소 안됨, 수정하려면 엑셀 드로잉 노가다
- 결과: 차라리 현장 제어기에서 직접 DAT 뽑아오는 게 더 빠름

### 목표 상태 (한 줄 요약)
> **"해날아파트" 클릭하면 → DAT 1개 + 주기표 1개 + 위치정보 → 끝.**

---

## 2. 최종 결과물

### 2-1. 프로그램 구성

| 구성 | 기술 | 설명 |
|------|------|------|
| **① 정리 스크립트** | Python CLI | 원본 DAT/주기표 → 자동분류 → 정리된 DB 폴더 생성 |
| **② 관리 웹앱** | React (PWA) | 요도 + 교차로별 DAT/주기표 조회/관리 |

### 2-2. 정리된 폴더 구조 (최종 목표)

```
📁 보령시_신호DB/
│
├── 📁 _원본/                          ← 원본 보존 (절대 수정 안 함)
│   ├── 📁 dat_원본/                    ← 기존 DAT 파일 전부 복사
│   └── 📁 주기표_원본/                 ← 기존 엑셀 전부 복사
│
├── 📁 _미분류/                         ← 자동분류 실패한 파일들
│   ├── 📁 dat_미분류/                  ← 파싱 실패 또는 매칭 불가
│   └── 📁 주기표_미분류/               ← 교차로명 추출 실패
│
├── 📁 교차로/                          ← ★ 핵심! 교차로별 1폴더
│   ├── 📁 해날아파트/
│   │   ├── 해날아파트.dat              ← 서돌 DAT 최신본 1개
│   │   ├── 해날아파트_주기표.xlsx      ← 주기표 1개
│   │   └── info.json                   ← 메타데이터
│   │
│   ├── 📁 대천해수욕장/
│   │   ├── 대천해수욕장.dat
│   │   ├── 대천해수욕장_주기표.xlsx
│   │   └── info.json
│   │
│   ├── 📁 보령역사거리/
│   │   ├── 보령역사거리.dat
│   │   ├── 보령역사거리_주기표.xlsx
│   │   └── info.json
│   │
│   └── ... (교차로 수만큼)
│
├── 📁 요도/
│   ├── routes.json                     ← 노선 + 제어기 위치 데이터
│   └── config.json                     ← 요도 설정 (색상, 레이블 등)
│
├── master.json                         ← 전체 교차로 마스터 목록
├── 분류보고서.md                       ← 자동분류 결과 리포트
└── README.md
```

### 2-3. info.json 예시 (교차로별 메타데이터)

```json
{
  "id": "BC-001",
  "name": "해날아파트",
  "alias": ["해날아파트사거리", "해날APT"],
  "type": "사거리",
  "manufacturer": "서돌전자",
  "controller_model": "STC-350",
  
  "dat": {
    "filename": "해날아파트.dat",
    "size": 14784,
    "manufacturer_detected": "SUHDOL",
    "date_created": "2018-12-05",
    "date_modified": "2022-04-27",
    "phone": "031-901-5120",
    "phases": 4,
    "plans": [
      { "plan": 0, "cycle": 150, "offset": 53, "splits": [45, 50, 30, 25] },
      { "plan": 1, "cycle": 160, "offset": 87, "splits": [45, 55, 32, 28] },
      { "plan": 2, "cycle": 160, "offset": 29, "splits": [45, 55, 32, 28] },
      { "plan": 3, "cycle": 150, "offset": 53, "splits": [45, 50, 30, 25] }
    ],
    "lsu_active": [true, true, true, true, true, true, true, false],
    "lsu_types": ["차량4색","보행2색","차량4색","보행2색","차량3색","보행2색","차량3색","보행2색"]
  },

  "location": {
    "lat": 36.3345,
    "lng": 126.6127,
    "address": "충남 보령시 대천로 123"
  },

  "routes": ["대천해수욕장로"],
  "status": "정상",
  "notes": "2022년 4월 주기 조정",
  
  "history": [
    { "date": "2024-01-15", "action": "DAT 파일 현장 수집", "by": "Jun" },
    { "date": "2022-04-27", "action": "주기 조정 (150→160초)", "by": "전임자" }
  ],

  "_classification": {
    "source_files": ["해날아파트.dat", "해날아파트(1).dat"],
    "selected": "해날아파트.dat",
    "reason": "SUHDOL 헤더 확인, 최신 날짜(2022-04-27) 기준 선택",
    "confidence": "high"
  }
}
```

---

## 3. ① 정리 스크립트 (Python) 상세 설계

### 3-1. 실행 흐름

```
[사용자]
  │
  ├── 📁 dat_원본/     ← "여기에 DAT 파일 다 때려넣어"
  └── 📁 주기표_원본/  ← "여기에 엑셀 다 때려넣어"
  
        │
        ▼
  
  $ python classify.py
  
        │
        ▼ STEP 1: DAT 파일 분석
        │
        │  모든 .dat 파일 스캔
        │  ├── 파일 크기 확인 (14,784B = 서돌, 그 외 = 한진 후보)
        │  ├── SUHDOL 시그니처 검색 → 서돌전자 확정
        │  ├── 한진 시그니처 검색 → 한진이엔씨 확정
        │  ├── 날짜 추출 (년/월/일)
        │  ├── 타이밍 계획 추출 (주기, 현시 수, 스플릿)
        │  ├── LSU 타입 추출
        │  └── 파일명에서 교차로명 추출 시도
        │
        ▼ STEP 2: 주기표 엑셀 분석
        │
        │  모든 .xlsx/.xls 파일 스캔
        │  ├── 시트명에서 교차로명 추출
        │  ├── 셀 내용에서 교차로명/주기/현시 정보 추출
        │  └── 교차로별로 시트 분리 → 개별 엑셀 생성
        │
        ▼ STEP 3: 매칭 & 분류
        │
        │  교차로명 기준으로 DAT ↔ 주기표 매칭
        │  ├── 정확매칭: 파일명/시트명 일치
        │  ├── 유사매칭: 편집거리, 부분문자열
        │  ├── 내용매칭: 주기/현시 수 비교
        │  └── 중복 시: 최신 날짜 우선, 서돌 우선
        │
        ▼ STEP 4: 정리된 폴더 생성
        │
        │  📁 교차로/{이름}/ 폴더 생성
        │  ├── DAT 복사 + 표준 이름 부여
        │  ├── 주기표 복사 (시트 분리된 개별 파일)
        │  └── info.json 생성
        │
        ▼ STEP 5: 리포트 생성
        
        📄 분류보고서.md
        ├── 총 파일 수 / 분류 성공 수 / 실패 수
        ├── 교차로별 상태 (DAT 있음/없음, 주기표 있음/없음)
        ├── 중복 파일 목록 + 선택 근거
        ├── 한진 파일 목록 (별도 관리)
        ├── 미분류 파일 목록 + 사유
        └── 수동 확인 필요 목록
```

### 3-2. DAT 파일 판별 로직

```python
def classify_dat(filepath):
    """DAT 파일 제조사 판별 + 메타데이터 추출"""
    
    with open(filepath, 'rb') as f:
        data = f.read()
    
    result = {
        'path': filepath,
        'size': len(data),
        'manufacturer': 'unknown',
        'intersection_name': None,  # 파일명에서 추출
        'date_modified': None,
        'date_created': None,
        'phases': 0,
        'plans': [],
        'confidence': 'low'
    }
    
    # ── 서돌전자 판별 ──
    if len(data) == 14784:  # 서돌 고정 크기
        # SUHDOL 시그니처 검색
        suhdol_pos = data.find(b'SUHDOL')
        if suhdol_pos >= 0:
            result['manufacturer'] = '서돌전자'
            result['signature'] = 'SUHDOL'
            result['confidence'] = 'high'
            
            # 날짜 추출 (0x07E6 = 2022 패턴)
            # ... (readDat 로직 활용)
            
            # 타이밍 계획 추출
            for plan_idx in range(4):
                offset = plan_idx * 20
                cycle = data[offset + 2]
                if cycle > 0:
                    splits = []
                    for ph in range(4, 12, 2):
                        val = data[offset + ph]
                        if val > 0:
                            splits.append(val)
                    if sum(splits) == cycle:  # 검증
                        result['plans'].append({
                            'cycle': cycle,
                            'offset': data[offset + 3],
                            'splits': splits
                        })
            
            result['phases'] = len(result['plans'][0]['splits']) if result['plans'] else 0
    
    # ── 한진이엔씨 판별 ──
    # (한진 시그니처 패턴은 추후 DAT 파일 확보 시 추가)
    # 서돌이 아닌 .dat 파일은 일단 한진 후보로 분류
    if result['manufacturer'] == 'unknown' and len(data) > 0:
        # 한진 고유 시그니처 검색 시도
        if b'HANJIN' in data or b'HJ' in data[:20]:
            result['manufacturer'] = '한진이엔씨'
            result['confidence'] = 'medium'
        else:
            result['manufacturer'] = '미확인'
            result['confidence'] = 'low'
    
    # 파일명에서 교차로명 추출
    basename = os.path.splitext(os.path.basename(filepath))[0]
    # 접미사 제거: (1), _백업, _copy, _old, _최신 등
    cleaned = re.sub(r'[\(\)\[\]（）]?\d*[\(\)\[\]（）]?$', '', basename)
    cleaned = re.sub(r'[_\-]?(백업|copy|old|최신|수정|원본|임시|test)$', '', cleaned, flags=re.I)
    cleaned = re.sub(r'^(서돌|한진|suhdol|hanjin)[_\-]?', '', cleaned, flags=re.I)
    result['intersection_name'] = cleaned.strip() if cleaned.strip() else None
    
    return result
```

### 3-3. 중복 해소 전략

```
같은 교차로에 DAT 파일 여러 개일 때 우선순위:

1. 제조사: 서돌전자 > 한진이엔씨 > 미확인
2. 날짜: SUHDOL 헤더 내 수정일이 최신인 것
3. 파일 크기: 14,784B (정상) > 기타
4. 파일명: 깔끔한 이름 > 번호 붙은 이름 (1), (2)

→ 선택된 파일 = "교차로명.dat"으로 복사
→ 나머지 = _원본/에 보존, info.json에 기록
```

### 3-4. 주기표 처리 로직

```
주기표 엑셀 처리:

1. 엑셀 파일 열기 (openpyxl)
2. 모든 시트 스캔
3. 시트명 = 교차로명으로 간주
   - "해날아파트" 시트 → 해날아파트_주기표.xlsx로 분리
   - "Sheet1" 같은 범용 이름 → 셀 내용에서 교차로명 추출 시도
4. 각 시트를 개별 엑셀로 저장
5. DAT의 교차로명과 매칭
```

---

## 4. ② 관리 웹앱 (React PWA) 상세 설계

### 4-1. 화면 구성

```
┌──────────────────────────────────────────────────────────┐
│  🚦 보령시 교통신호 관리 시스템          🔍 검색...      │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  [요도]  [교차로목록]  [DAT뷰어]  [통계]                 │
│                                                          │
│  ┌─── 요도 탭 ─────────────────────────────────────┐    │
│  │                                                   │    │
│  │    (지하철 노선도 스타일 SVG)                     │    │
│  │                                                   │    │
│  │    ●━━━━━●━━━━━●━━━━━●  대천해수욕장로           │    │
│  │              ┃                                    │    │
│  │    ●━━━━━●━━━●━━━━━●  보령중앙로                 │    │
│  │                                                   │    │
│  │    [+노선추가] [편집모드] [줌+] [줌-]             │    │
│  │                                                   │    │
│  │    클릭 → 팝업:                                   │    │
│  │    ┌─────────────────────────┐                    │    │
│  │    │ 해날아파트 (BC-001)     │                    │    │
│  │    │ 서돌전자 | 4현시 | 150초│                    │    │
│  │    │ DAT: ✅ | 주기표: ✅    │                    │    │
│  │    │ [DAT보기] [주기표보기]  │                    │    │
│  │    │ [DAT다운] [주기표다운]  │                    │    │
│  │    └─────────────────────────┘                    │    │
│  └───────────────────────────────────────────────────┘    │
│                                                          │
│  ┌─── 교차로목록 탭 ───────────────────────────────┐    │
│  │                                                   │    │
│  │  🔍 필터: [전체▼] [서돌▼] [정상▼] [노선▼]       │    │
│  │                                                   │    │
│  │  │ ID     │ 교차로명      │ 제조사   │ 현시 │ DAT │ 주기표 │ 상태   │    │
│  │  │ BC-001 │ 해날아파트    │ 서돌전자 │ 4    │ ✅  │ ✅     │ 🟢정상 │    │
│  │  │ BC-002 │ 대천해수욕장  │ 서돌전자 │ 3    │ ✅  │ ❌     │ 🟡주기표없음 │    │
│  │  │ BC-003 │ 보령역        │ 한진     │ -    │ ✅  │ ✅     │ 🔴교체예정 │    │
│  │                                                   │    │
│  │  정렬: 노선순 / 이름순 / 상태순                   │    │
│  └───────────────────────────────────────────────────┘    │
│                                                          │
│  ┌─── 통계 탭 ─────────────────────────────────────┐    │
│  │  총 교차로: 41개                                  │    │
│  │  서돌전자: 35 / 한진이엔씨: 6                    │    │
│  │  DAT 확보: 38/41 (92.7%)                          │    │
│  │  주기표 확보: 30/41 (73.2%)                       │    │
│  │  교체예정: 6개                                    │    │
│  │  미확인: 3개                                      │    │
│  └───────────────────────────────────────────────────┘    │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### 4-2. 기능 목록

#### 요도 (인터랙티브 노선도)
- SVG 벡터 기반 지하철 노선도 스타일
- 마우스 휠 줌 / 드래그 팬
- 제어기 클릭 → 상세정보 팝업 (DAT정보, 주기, 상태)
- 노선 추가/삭제/편집 (드래그로 순서 변경)
- 제어기 추가: 노선 위에 클릭하여 새 제어기 삽입
- 상태별 색상: 🟢정상 / 🟡점검필요 / 🔴교체예정 / ⚪미확인
- 검색: 교차로명/ID 입력 → 해당 위치 자동 포커스 + 하이라이트
- **routes.json에서 데이터 로드 / 수정 시 자동 저장**

#### 교차로 관리
- 교차로별 상세페이지: DAT 정보 + 주기표 + 히스토리
- DAT 파일 업로드 → 자동 파싱 → info.json 업데이트
- 주기표 업로드 → 교차로 폴더에 저장
- DAT/주기표 다운로드
- 메모/히스토리 기록

#### 검색 & 필터
- 통합 검색: 교차로명, ID, DAT파일명
- 필터: 제조사, 상태, 노선, DAT유무, 주기표유무

### 4-3. 데이터 흐름

```
📁 보령시_신호DB/               ← 로컬 파일시스템 (프로젝트 루트)
    │
    ├── master.json              ← 전체 교차로 마스터
    ├── 요도/routes.json         ← 노선도 데이터
    └── 교차로/*/info.json       ← 교차로별 메타
    
        ▲ 읽기/쓰기
        │
  ┌─────┴─────┐
  │  로컬 API  │  ← Express 서버 (또는 Tauri)
  │  서버      │     파일 I/O + DAT 파싱
  └─────┬─────┘
        │
        ▼
  ┌───────────┐
  │  React    │  ← 브라우저 UI
  │  프론트엔드│     요도 + 목록 + 뷰어
  └───────────┘
```

---

## 5. 기술 스택 결정

```
① 정리 스크립트:
   - Python 3.10+
   - openpyxl (엑셀 처리)
   - 표준 라이브러리만 (struct, os, re, json, shutil)

② 관리 웹앱:
   - 프론트엔드: React + Vite
   - 백엔드: Express.js (Node.js)
   - 데이터: JSON 파일 (DB 없음, 파일시스템 기반)
   - DAT 파싱: JavaScript (v10 코드 재활용)
   - 배포: 로컬 실행 (npm run dev)
   
   → 나중에 Tauri로 감싸면 데스크톱 앱 가능
   → 나중에 PWA로 모바일 접근 가능
```

---

## 6. 개발 순서 (Claude Code 작업 순서)

### Phase 1: 정리 스크립트 (최우선)
```
목표: 기존 카오스 → 정리된 폴더 구조

작업:
1. classify.py 작성
   - DAT 파일 스캐너 (서돌/한진 판별, 메타데이터 추출)
   - 주기표 엑셀 스캐너 (시트별 분리, 교차로명 추출)
   - 매칭 엔진 (DAT ↔ 주기표 교차로명 매칭)
   - 폴더 생성기 (교차로별 정리)
   - 리포트 생성기

2. 테스트
   - 해날아파트.dat로 서돌 파싱 검증
   - 더미 엑셀로 시트 분리 검증

산출물:
   - classify.py (메인 스크립트)
   - dat_parser.py (서돌/한진 DAT 파서)
   - xlsx_parser.py (주기표 처리)
   - matcher.py (매칭 로직)
```

### Phase 2: 관리 웹앱 기본
```
목표: 정리된 폴더를 웹으로 조회

작업:
1. Express API 서버
   - GET /api/intersections (master.json 읽기)
   - GET /api/intersection/:id (info.json 읽기)
   - GET /api/routes (routes.json 읽기)
   - GET /api/file/:id/:type (DAT/주기표 다운로드)
   - PUT /api/intersection/:id (info.json 수정)
   - PUT /api/routes (routes.json 수정)
   - POST /api/upload/:id (DAT/주기표 업로드)

2. React 프론트엔드
   - 교차로 목록 (테이블 + 검색 + 필터)
   - 교차로 상세 (DAT 정보 표시)
   - 통계 대시보드
```

### Phase 3: 요도 (인터랙티브 노선도)
```
목표: 엑셀 요도를 인터랙티브 웹으로 교체

작업:
1. SVG 기반 노선도 렌더러
   - routes.json → SVG 변환
   - 줌/팬 인터랙션
   - 제어기 클릭 → 상세 팝업

2. 편집 모드
   - 노선 추가/삭제
   - 제어기 위치 드래그
   - 실시간 저장

3. 기존 엑셀 요도 → routes.json 변환 스크립트
```

### Phase 4: 고급 기능 (나중에)
```
- DAT 파일 비교 (2개 DAT diff)
- 주기 변경 이력 추적
- v10 연동 (관리앱에서 바로 시뮬레이터 열기)
- 제어기 교체 워크플로우 (한진→서돌 전환 가이드)
```

---

## 7. 핵심 데이터 구조

### master.json (전체 교차로 목록)

```json
{
  "version": "1.0",
  "created": "2026-02-13",
  "city": "보령시",
  "total": 41,
  "intersections": [
    {
      "id": "BC-001",
      "name": "해날아파트",
      "manufacturer": "서돌전자",
      "route": "대천해수욕장로",
      "has_dat": true,
      "has_cycle_table": true,
      "status": "정상",
      "phases": 4,
      "cycle": 150
    },
    ...
  ]
}
```

### routes.json (요도 데이터)

```json
{
  "routes": [
    {
      "id": "R1",
      "name": "대천해수욕장로",
      "color": "#3b82f6",
      "controllers": [
        { "id": "BC-001", "name": "해날아파트", "x": 100, "y": 200, "order": 1 },
        { "id": "BC-002", "name": "대천역", "x": 250, "y": 200, "order": 2 },
        { "id": "BC-003", "name": "해수욕장입구", "x": 400, "y": 200, "order": 3 }
      ]
    },
    {
      "id": "R2",
      "name": "보령중앙로",
      "color": "#ef4444",
      "controllers": [
        { "id": "BC-002", "name": "대천역", "x": 250, "y": 200, "order": 1 },
        { "id": "BC-010", "name": "중앙시장", "x": 250, "y": 350, "order": 2 },
        { "id": "BC-011", "name": "보령시청", "x": 250, "y": 500, "order": 3 }
      ]
    }
  ]
}
```

---

## 8. Claude Code에 전달할 첫 번째 작업

### 작업 지시:

```
Phase 1 - 정리 스크립트 개발

프로젝트 루트에 다음 구조를 만들어주세요:

boryeong-signal-db/
├── scripts/
│   ├── classify.py          # 메인 실행 스크립트
│   ├── dat_parser.py        # 서돌전자 DAT 파서 (v10 로직 Python 포팅)
│   ├── xlsx_parser.py       # 주기표 엑셀 처리
│   └── matcher.py           # DAT ↔ 주기표 매칭
├── _원본/
│   ├── dat_원본/            # 여기에 기존 DAT 파일 넣기
│   └── 주기표_원본/         # 여기에 기존 엑셀 넣기
└── README.md

실행: python scripts/classify.py
결과: 📁 교차로/ 폴더에 정리된 구조 생성

서돌전자 DAT 파싱 기준:
- 파일 크기: 14,784 bytes (0x39C0)
- SUHDOL 시그니처: 오프셋 0x391D 또는 0x395A
- 타이밍: 오프셋 0x0000부터 20바이트씩 (주기=+2, 옵셋=+3, 현시=+4~+11)
- 날짜: 0x07E6=2022, Big-Endian year(2B)+month(1B)+day(1B)
- 전화번호: "031-901-5120" (ASCII)
- LSU 타입: 오프셋 0x2F6A (0x44=차량4색, 0x33=차량3색, 0x88=보행2색)
- LSU 활성: 오프셋 0x0CDA (1=활성, 0=비활성)

원본은 절대 수정하지 않고 복사만 합니다.
분류 결과는 분류보고서.md에 상세히 기록합니다.
```

---

## 9. 요약

| 단계 | 무엇을 | 어떻게 | 결과 |
|------|--------|--------|------|
| **Phase 1** | DAT+주기표 정리 | Python 스크립트 | 교차로별 폴더 정리 완료 |
| **Phase 2** | 웹으로 조회 | React+Express | 교차로 목록/상세/검색 |
| **Phase 3** | 요도 교체 | SVG 인터랙티브 | 엑셀 요도 → 웹 노선도 |
| **Phase 4** | 고급 기능 | v10 연동 등 | 시뮬레이션 연결 |

> **핵심 원칙: 교차로 1개 = 폴더 1개 = DAT 1개 + 주기표 1개**
> 
> 이것만 지키면 누가 봐도 이해할 수 있는 구조가 됩니다.
