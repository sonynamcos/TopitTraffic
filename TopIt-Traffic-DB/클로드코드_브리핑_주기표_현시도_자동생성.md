# 🚦 교통신호 주기표 엑셀 — 현시도 자동 생성 브리핑

## 프로젝트 개요

교통신호제어기 DB 관리 도구 (React JSX, Artifact로 실행)에서
**엑셀 주기표**를 내보낼 때, 현시별 화살표 그림(현시도)을 자동 생성해서 삽입해야 함.

현재 v10에서 엑셀 내보내기 자체는 이미 구현됨 (JSZip으로 .xlsx 템플릿 조작).
**남은 작업: 현시 데이터 → 화살표 이미지 생성 → 엑셀 셀에 삽입**

---

## 엑셀 템플릿 구조 (주기표양식.xlsx)

시트명: `해날아파트` (첫 번째 시트)

### 헤더 영역
| 셀 | 내용 |
|------|------|
| A4 | `교차로명 :` → D4에 교차로명 값 |
| J4 | `교차로번호 :` → L4에 번호 값 |
| N4 | `교차로군 :` |
| R4 | `작성년월 :` |

### 현시 헤더 (Row 5, 병합셀)
| 셀 | 내용 | 병합 |
|------|------|------|
| J5 | Φ1 | J5:K5 |
| L5 | Φ2 | L5:M5 |
| N5 | Φ3 | N5:O5 |
| P5 | Φ4 | P5:Q5 |
| R5 | Φ5 | R5:S5 |
| T5 | Φ6 | T5:U5 |

### ★ 현시도 삽입 영역 (Row 6~7) — 이게 핵심!
- **J6:K7 ~ T6:U7** 각 현시(Φ1~Φ6)마다 2행×2열 병합 영역
- 여기에 **현시별 화살표 이미지**를 삽입해야 함
- 이미지 크기: 약 80×50px 정도 (셀 크기에 맞춤)

### RING A 현시도 (Row 8~9)
| 셀 | 레이블 | 이미지 위치 |
|------|--------|------------|
| G8 | `RING A` | G8:I9 병합 |
| J8:K9 | A1 현시도 | 병합셀에 이미지 |
| L8:M9 | A2 현시도 | 병합셀에 이미지 |
| N8:O9 | A3 현시도 | ... |
| P8:Q9 | A4 현시도 | ... |
| R8:S9 | A5 현시도 | ... |
| T8:U9 | A6 현시도 | ... |

### RING B 현시도 (Row 10~11)
| 셀 | 레이블 | 이미지 위치 |
|------|--------|------------|
| G10 | `RING B` | G10:I11 병합 |
| J11:K11 | B1 현시도 | 병합셀에 이미지 |
| L11:M11 | B2 현시도 | ... |
| ... | ... | ... |

### SIGNAL TABLE (Row 14~27, 각 행 2행 병합)
| 행 | 항목 | 비고 |
|----|------|------|
| 14-15 | OPTION | 각 현시 RING A/B 값 |
| 16-17 | MIN. GREEN | 최소녹색 |
| 18-19 | MAX.Ⅱ | 최대녹색 |
| 20-21 | YELLOW(RED) | 황색 |
| 22-23 | BEF. PED. | 보행대기 |
| 24-25 | WALK | 보행녹색 |
| 26-27 | WALK CLEAR | 보행점멸 |

### PLAN TABLE (Row 29~)
- TIME PLAN 1: 수준별 주기/연동/시간분할
- TOD PLAN 1~3: 시각별 수준 배정

---

## 데이터 모델 (JSX에서 관리)

### phases 배열 (현시 목록)
```javascript
phases = [
  {
    lsus: {
      1: "직진",     // LSU1 = 북(N) 차량 → 직진
      5: "직진",     // LSU5 = 남(S) 차량 → 직진
      8: "보행",     // LSU8 = 북(N) 보행
      4: "보행",     // LSU4 = 남(S) 보행
    },
    pedWait: 1,      // 보행대기(초)
    pedGreen: 11,    // 보행녹색(초)
    pedFlash: 7,     // 보행점멸(초)
    yellow: 3,       // 황색(초)
  },
  {
    lsus: { 1: "좌회전" },  // LSU1 = 북 좌회전만
    pedWait: 0, pedGreen: 0, pedFlash: 0, yellow: 3,
  },
  {
    lsus: {
      3: "직진",     // LSU3 = 동(E) 차량 → 직진
      7: "직진",     // LSU7 = 서(W) 차량 → 직진
      2: "보행",     // LSU2 = 동(E) 보행
      6: "보행",     // LSU6 = 서(W) 보행
    },
    pedWait: 1, pedGreen: 9, pedFlash: 6, yellow: 3,
  },
  {
    lsus: { 3: "좌회전" },  // LSU3 = 동 좌회전만
    pedWait: 0, pedGreen: 0, pedFlash: 0, yellow: 3,
  },
]
```

### LSU 설정 (고정 매핑)
```javascript
DEFAULT_LSU = [
  { lsu: 1, dir: "북", type: "차량", pos: "top" },
  { lsu: 2, dir: "동", type: "보행", pos: "right-ped" },
  { lsu: 3, dir: "동", type: "차량", pos: "right" },
  { lsu: 4, dir: "남", type: "보행", pos: "bottom-ped" },
  { lsu: 5, dir: "남", type: "차량", pos: "bottom" },
  { lsu: 6, dir: "서", type: "보행", pos: "left-ped" },
  { lsu: 7, dir: "서", type: "차량", pos: "left" },
  { lsu: 8, dir: "북", type: "보행", pos: "top-ped" },
]
```

### 이동류(movement) 종류
| 값 | 의미 | Ring | 화살표 |
|----|------|------|--------|
| `"직진"` | 직진 | Ring A | 실선 직선 화살표 |
| `"좌회전"` | 좌회전 | Ring B | 실선 꺾인 화살표 |
| `"직좌"` | 직진+좌회전 | Ring A+B | 직진+좌회전 화살표 둘 다 |
| `"보행"` | 보행자 | Ring A | 점선 화살표 |

---

## ★ 현시도 그림 규칙 (핵심)

### 좌표 체계
교차로를 위에서 내려다본 뷰. 4방향 도로가 십자로 교차.

```
        북(N)
         ↑
서(W) ←  ✚  → 동(E)
         ↓
        남(S)
```

### 화살표 그리기 규칙

각 현시의 `lsus` 에서 **방향+이동류** 조합을 읽어 화살표를 그림:

| LSU | 방향 | 이동류 | 화살표 모양 |
|-----|------|--------|------------|
| LSU1 (북) | 직진 | 위→아래 직선 실선 화살표 (↓) |
| LSU1 (북) | 좌회전 | 위에서 들어와 오른쪽으로 꺾임 (↓→) |
| LSU1 (북) | 직좌 | 직진+좌회전 둘 다 |
| LSU3 (동) | 직진 | 오른쪽→왼쪽 직선 실선 화살표 (←) |
| LSU3 (동) | 좌회전 | 오른쪽에서 들어와 아래로 꺾임 (←↓) |
| LSU5 (남) | 직진 | 아래→위 직선 실선 화살표 (↑) |
| LSU5 (남) | 좌회전 | 아래에서 들어와 왼쪽으로 꺾임 (↑←) |
| LSU7 (서) | 직진 | 왼쪽→오른쪽 직선 실선 화살표 (→) |
| LSU7 (서) | 좌회전 | 왼쪽에서 들어와 위로 꺾임 (→↑) |
| LSU8 (북보행) | 보행 | 좌우 점선 양방향 화살표 (⟵---⟶) 북쪽 횡단보도 위치 |
| LSU4 (남보행) | 보행 | 좌우 점선 양방향 화살표, 남쪽 횡단보도 위치 |
| LSU2 (동보행) | 보행 | 상하 점선 양방향 화살표, 동쪽 횡단보도 위치 |
| LSU6 (서보행) | 보행 | 상하 점선 양방향 화살표, 서쪽 횡단보도 위치 |

### 현시도 vs RING 도

1. **현시도 (Φ1~Φ6, Row 6~7)**:
   - 해당 현시의 **모든** 이동류를 한 그림에 표시
   - 차량 직진/좌회전 + 보행 전부 포함

2. **RING A 도 (A1~A6, Row 8~9)**:
   - Ring A에 해당하는 이동류만 표시
   - **직진(0x10)** + **보행(0x01/0x05)** 만

3. **RING B 도 (B1~B6, Row 10~11)**:
   - Ring B에 해당하는 이동류만 표시
   - **좌회전(0x01)** 만

### 그림 스타일
- 배경: 흰색 (엑셀 셀 배경)
- 차량 화살표: **검정 실선**, 굵기 2~3px
- 보행 화살표: **검정 점선**, 굵기 1~2px
- 화살촉: 삼각형 또는 V자형
- 교차로 중심: 작은 십자 또는 사각형 (선택)
- 이미지 크기: 약 100×80px (셀에 맞춤)

---

## 구현 방법 옵션

### 옵션 A: Canvas → PNG → XLSX 삽입 (웹 브라우저 내)
1. 숨겨진 `<canvas>` 에 화살표 그림
2. `canvas.toDataURL("image/png")` 로 PNG 추출
3. JSZip으로 xlsx 내부에 이미지 삽입:
   - `xl/media/image1.png` ~ `imageN.png` 추가
   - `xl/drawings/drawing1.xml` 생성 (이미지 위치/크기 정의)
   - `xl/worksheets/_rels/sheet1.xml.rels` 에 drawing 관계 추가
   - `[Content_Types].xml` 에 png 타입 추가

### 옵션 B: Python openpyxl (로컬 스크립트)
1. Pillow로 화살표 이미지 생성
2. openpyxl의 `openpyxl.drawing.image.Image` 로 삽입
3. `ws.add_image(img, 'J6')` 식으로 위치 지정

### 옵션 C: SVG 생성 후 변환
- SVG로 화살표 생성 → PNG 변환 → XLSX 삽입

**권장: 옵션 A** (기존 JSZip 기반 엑셀 내보내기와 통합 가능)

---

## XLSX에 이미지 삽입 시 필요한 XML 구조

### 1. `[Content_Types].xml` 에 추가
```xml
<Default Extension="png" ContentType="image/png"/>
```

### 2. `xl/drawings/drawing1.xml` 생성
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<xdr:wsDr xmlns:xdr="http://schemas.openxmlformats.org/drawingml/2006/spreadsheetDrawing"
          xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"
          xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <xdr:twoCellAnchor>
    <xdr:from><xdr:col>9</xdr:col><xdr:colOff>0</xdr:colOff><xdr:row>5</xdr:row><xdr:rowOff>0</xdr:rowOff></xdr:from>
    <xdr:to><xdr:col>11</xdr:col><xdr:colOff>0</xdr:colOff><xdr:row>7</xdr:row><xdr:rowOff>0</xdr:rowOff></xdr:to>
    <xdr:pic>
      <xdr:nvPicPr>
        <xdr:cNvPr id="2" name="Phase1"/>
        <xdr:cNvPicPr><a:picLocks noChangeAspect="1"/></xdr:cNvPicPr>
      </xdr:nvPicPr>
      <xdr:blipFill>
        <a:blip r:embed="rId1"/>
        <a:stretch><a:fillRect/></a:stretch>
      </xdr:blipFill>
      <xdr:spPr>
        <a:xfrm><a:off x="0" y="0"/><a:ext cx="0" cy="0"/></a:xfrm>
        <a:prstGeom prst="rect"><a:avLst/></a:prstGeom>
      </xdr:spPr>
    </xdr:pic>
    <xdr:clientData/>
  </xdr:twoCellAnchor>
  <!-- 반복: Phase2 ~ Phase6, RingA1~A6, RingB1~B6 -->
</xdr:wsDr>
```

### 3. `xl/drawings/_rels/drawing1.xml.rels`
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="../media/image1.png"/>
  <!-- rId2 ~ rIdN for each image -->
</Relationships>
```

### 4. `xl/worksheets/_rels/sheet1.xml.rels` 에 추가
```xml
<Relationship Id="rIdDrawing" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/drawing" Target="../drawings/drawing1.xml"/>
```

### 5. `xl/worksheets/sheet1.xml` 에 `<drawing>` 태그 추가
```xml
<drawing r:id="rIdDrawing"/>
```

### 셀 위치 → 열/행 인덱스 매핑 (0-based)
| 현시 | 현시도 위치 | col from | col to | row from | row to |
|------|-----------|----------|--------|----------|--------|
| Φ1 | J6:K7 | 9 | 11 | 5 | 7 |
| Φ2 | L6:M7 | 11 | 13 | 5 | 7 |
| Φ3 | N6:O7 | 13 | 15 | 5 | 7 |
| Φ4 | P6:Q7 | 15 | 17 | 5 | 7 |
| Φ5 | R6:S7 | 17 | 19 | 5 | 7 |
| Φ6 | T6:U7 | 19 | 21 | 5 | 7 |
| A1 | J8:K9 | 9 | 11 | 7 | 9 |
| A2 | L8:M9 | 11 | 13 | 7 | 9 |
| ... | ... | ... | ... | ... | ... |
| B1 | J10:K11 | 9 | 11 | 9 | 11 |
| B2 | L10:M11 | 11 | 13 | 9 | 11 |
| ... | ... | ... | ... | ... | ... |

---

## 예시: 4현시 사거리

```
Φ1: 남북직진+보행  → LSU1(북직진) + LSU5(남직진) + LSU8(북보행) + LSU4(남보행)
Φ2: 북좌회전       → LSU1(북좌회전)
Φ3: 동서직진+보행  → LSU3(동직진) + LSU7(서직진) + LSU2(동보행) + LSU6(서보행)
Φ4: 동좌회전       → LSU3(동좌회전)
```

### Φ1 현시도 (모든 이동류)
```
     ↓ (북→남 직진)
  ⟵---⟶ (북 보행, 점선)
  
     ↑ (남→북 직진)
  ⟵---⟶ (남 보행, 점선)
```

### A1 Ring A 도 (직진+보행만)
```
  ↑↑ (남북 직진)
  ⟵---⟶ (보행, 점선)
```

### B1 Ring B 도 (좌회전만)
```
  (없음 - Φ1은 좌회전 없음)
```

### B2 Ring B 도
```
  ↓→ (북에서 들어와 동으로 좌회전)
```

---

## 참고 파일

- `주기표양식.xlsx` — 엑셀 템플릿 (업로드됨)
- `topit-signal-tool-v10.jsx` — 현재 버전 소스 (1405줄)
- `1770856235683_image.png` — 완성된 주기표 예시 (참고용)

## 기존 엑셀 내보내기 코드 위치

`topit-signal-tool-v10.jsx` 307행 `exportExcel` 함수.
현재 JSZip으로 템플릿 .xlsx를 열어 셀 값만 교체하는 방식.
여기에 이미지 생성+삽입 로직을 추가해야 함.

---

## 요약: 해야 할 일

1. **`drawPhaseArrows(phase, mode)` 함수 구현**
   - `phase`: 현시 데이터 (lsus 객체)
   - `mode`: `"all"` (현시도) / `"ringA"` (Ring A만) / `"ringB"` (Ring B만)
   - Canvas에 화살표 그린 후 PNG dataURL 반환

2. **`exportExcel` 함수 확장**
   - 각 현시별로 3종류 이미지 생성 (현시도, RingA, RingB)
   - JSZip으로 xlsx 내부에:
     - `xl/media/` 에 PNG 파일들 추가
     - `xl/drawings/drawing1.xml` 생성
     - 관련 rels 파일 업데이트
     - sheet XML에 `<drawing>` 참조 추가
